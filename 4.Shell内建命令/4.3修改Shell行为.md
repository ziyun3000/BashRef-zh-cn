## 4.3 修改Shell行为（Modifying Shell Behavior）

### 4.3.1 内建命令set（The Set Builtin）

这个内建命令相对来说比较复杂，所以要使用一个小节来进行说明。你可以使用“set”来改变shell选项的值和设置位置参数，或用来显示shell变量的名称和其值。

<p style="background-color: black">
set [--abefhkmnptuvxBCEHPT] [-o <i>option-name</i>] [<i>argument</i> ...]
set [+abefhkmnptuvxBCEHPT] [+o <i>option-name</i>] [<i>argument</i> ...]
</p>

如果没有选项或参数出现，set则显示所有变量和函数的名称和值。其显示顺序是按当前语言区域字母顺序。其显示格式是可用于重新输入对其当前变量进行设置或重置的格式。只读变量不能进行重置。在POSIX模式中，只会显示出shell变量。

当在命令中使用了选项，可对shell属性进行设置或释放。如果指定了选项，则具有下列含义：

#### -a 

每个创建或修改的变量或函数都具有导出属性，并且标记为可导出到后继命令的执行环境中。

#### -b 

会立即报告已终结的后台作业状态，而不是在下一个主提示符出现之前打印。

#### -e 

如果由简单命令、或命令列表、或复合命令组成的管道返回一个非零状态时，则立即退出。如果这些失败的命令出现在：紧随关键字“while”或“until”后面出现的命令列表中的一部分时；在“if”语句中测试条件部分中；在“&&”或“||”列表中的一部分，但这两个操作符不作为终结符时；在管道中的任意命令，但不是最后一条命令；或命令返回状态是使用“!”进行反转的，Shell都不会退出。如果因为当“-e”被忽略时执行一个命令失败引起了非子shell的复合命令返回一个非零状态，则shell不会退出。如果设置了ERR捕获器，在shell即出之前会执行该捕获。<br>该选项分别应用于shell环境和每一个子shell环境。并且可能引起在子shell执行所有命令之前就退出该子shell。<br>如果在忽略“-e”的上下文中执行一个复合命令或shell函数，没有一个执行于复合命令或函数主体中的命令会被“-e”的设置所影响，即使设置了“-e”选项并且命令返回一个失败状态。如果在一个忽略“-e”的执行上下文中的一个复合命令或shell函数设置了“-e”，则直到复合命令或命令包含的函数调用完成后，这个设置才会生效。

#### -f 

禁用文件名扩展（globbing）。

#### -h 

定位并且记住（使用哈希表）已查找过的可执行命令。该选项默认开启。

#### -k 

所有用于命令的赋值语句形式的参数都放置于环境中，不仅仅是命令名前面那些。

#### -m 

开启作业控制。所有进程运行在一个分开的进程组中。当一个后台作业完成时，shell打印一行退出状态。

#### -n 

只读取命令但不执行它们。这可以用于检查脚本的语法错误。在shell交互模式下忽略这个选项。

#### -o *option-name* 

依照“*option-name*”来设置选项：

- allexport：与“-a”选项相同。
- braceexpand：与“-B”选项相同。
- emacs：使用emacs风格的行编辑界面。这也会影响到“read -e”使用的编辑界面。
- errexit：与“-e”选项相同。
- errtrace：与“-E”选项相同。
- functrace：与“-T”选项相同。
- hashall：与“-h”选项相同。
- histexpand：与“-H”选项相同。
- history：开启命令历史记录，其详细说明请参考9.1《Bash历史工具》。在shell交互模式下默认开启该项。
- ignoreeof：交互模式的shell在读到EOF时不会退出。
- keyword：与“-k”选项相同。
- monitor：与“-m”选项相同。
- noclobber：与“-C”选项相同。
- noexec：与“-n”选项相同。
- noglob：与“-f”选项相同。
- nolog：当前忽略。
- notify：与“-b”选项相同。
- nounset：与“-u”选项相同。
- onecmd：与“-t”选项相同。
- physical：与“-P”选项相同。
- pipefail：如果设置了该选项，管道的返回值就是管道中最后（最右）一条命令退出时的非零状态值。或如果在管道中的所有命令成功退出，则返回零。默认禁用此选项。
- posix：在当Bash的默认操作行为不同于POSIX标准（参见6.11《Bash POSIX标准》）时，改变其行为来符合POSIX标准。该选项的意图是使Bash行为作为POSIX标准的受限超集。
- privileged：与“-p”选项相同。
- verbose：与“-v”选项相同。
- vi：使用vi风格的行编辑界面。这也会影响到“read -e”的编辑界面。
- xtrace：与“-x”选项相同。

#### -p

开启特权模式。在这个模式下，不会处理在“$BASH_ENV”和“$ENV”中的文件；不会从环境中继承shell函数；如果在环境中出现变量“SHELLOPTS”、“BASHOPTS”、“CDPATH”和“GLOBIGNORE”时，则忽略它们。如果shell启动时的有效用户（或组）id不等于真实用户（或组）id，并且没有给出“-p”选项，则会进行上面的这些动作并且将有效用户id设置为真实用户id。如果在启动时给出了“-p”选项，则有效用户id不会被重置。关闭这个选项会使有效用户id和组id设置为真实用户id和组id。

#### -t

在读取并执行一个命令后退出。

#### -u

在执行参数扩展时，视未设置的变量和参数为错误，但不包括特殊参数“@”和“*”。报错信息会写入标准报错流中，并且非交互模式的shell会退出。

#### -v

打印shell输入行读取的内容。

#### -x

在简单命令、for命令、case命令、select命令和算术for命令扩展之后和执行之前，打印其追踪信息和其参数或关联的单词列表。在命令和其扩展参数之前，先打印变量PS4值的扩展结果值。

#### -B

Shell会执行大括号扩展（参见3.5.1《大括号扩展》）。该选项默认开启。

#### -C

防止使用“>”、“>&”和“<>”重定向将现有文件进行覆盖。

#### -E

如果设置该项，在子shell环境中执行的shell函数、命令替换和命令可继承任意ERR捕获器。通常在上述情况下不会继承ERR捕获器。

#### -H

开启“!”风格的历史替换（参见9.3《历史交互》）。在交互模式下的shell该选项默认是开启的。

#### -P

如果设置了该项，在执行像“cd”这种改变当前工作目录的命令时，不会对软链接进行解析。则是使用物理目录代替。默认情况下，在使用命令改变当前目录时，Bash会跟随目录逻辑链。
例如，如果“/usr/sys”是一个指到“/usr/local/sys”的软链接，则：

```bash
$ cd /usr/sys; echo $PWD
/usr/sys
$ cd ..; pwd
/usr
```

如果设置了“-P”选项，则：

```bash
$ cd /usr/sys; echo $PWD
/usr/local/sys
$ cd ..; pwd
/usr/local
```

#### -T

如果设置该项，在子shell环境中执行的shell函数、命令替换和命令可继承任意DEBUG和RETURN捕获器。通常在上述情况下不会继承DEBUG和RETURN捕获器。

#### --

如果在该项后没有跟随“*argument*”参数，则将所有位置参数释放。否则，将位置参数设置为给出的“*argument*”参数，即使它们其中的一些开头是“-”。

#### -

代表选项结束，将所有剩余“*argument*”参数分配给位置参数。关闭“-x”和“-v”选项。如果没有给出“*argument*”参数，则不对位置参数进行任何改变。

<br>
使用“+”而不是“-”来对选项进行关闭操作。这些选项也可以在调用shell时使用。当前选项的设置可以在变量“$-”中找到。

命令后面的N个“*argument*”参数是位置参数，并按顺序分配给“$1”、“$2”到“$N”。特殊参数“#”设置为N。

返回状态总是为零，除非提供了一个无效的选项。

### 4.3.2 内建命令shopt（The Shopt Builtin）

该内建命令可以让你更改额外的shell可选的行为。

<p style="background-color: black">
shopt [-pqsu] [-o] [<i>optname</i> ...]
</p>

使用开关设置切换控制可选的shell行为。这些设置可以是下面列出的这些，或如果使用了“-o”选项，则可以设置内建命令set的“-o”选项。运行命令时不加选项，或使用“-p”选项时，则列出所有可设置选项，指出这些选项是开启了还是未开启；如果给出了“*optname*”参数，则只输出这些选项。“-p”选项可以使输出的显示格式可重新用于输入设置。其它选具有以下含义：

选项 | 含义
--- | ---
-s | 开启（即设置）每个给出的“*optname*”选项。
-u | 关闭（即释放）每个给出的“*optname*”选项。
-q | 抑制普通输出；返回状态反映的是“*optname*”选项是设置了还是释放了。如果在使用“-q”时给出了多个“*optname*”参数，则如果所有“*optname*”是开启的，返回状态为零；否则为非零。
-o | 限制“*optname*”的值只是定义在set命令中“-o”选项的值。

如果在使用“-s”或“-u”选项时不加“*optname*”参数，shopt只会显示开启的或关闭的shell选项列表。

除非有其它注释，shopt选项默认是关闭的。

如果列出的所有“*optname*”的选项都是开启的，则返回状态为零；否则为非零。当在设置或释放选项操作时，其正常返回状态为零，除非“*optname*”是一个无效的shell选项。

shopt选项列表：

**assoc_expand_once**

> 如果开启了该选项，在执行可执行变量赋值的内建命令时，和在执行数组引用解除的内建命令时，shell会在算术表达式运算期间抑制关联数组下标的多次运算。

**autocd**

> 如果开启了该选项，可将目录名作为一个命令名执行，就像其作为cd命令的参数一样执行。该选项只用于交互式shell。

**cdable_vars**

> 如果开启了该选项，如果内建命令cd的参数不是一个目录的话，则假设其是一个变量名，其值作为要改变的目标目录。

**cdspell**

> 如果开启了该选项，在cd命令中对于目录的微小拼写错误会被更正。会对字符的颠倒顺序、字符缺失和单一字符重复进行错误检查。如果找到纠错，则打印纠正的路径并运行命令。该选项只用于交互式shell。

**checkhash**

> 如果开启了该选项，Bash会在试图执行命令之前在哈希表中查找该命令。如果哈希表中不存在该命令，则执行常规的命令搜索操作。

**checkjobs**

> 如果开启了该选项，在退出交互式shell之前，Bash会列出所有已停止和正在运行的作业状态。如果有作业处于运行状态，这会引起在没有干预命令情况下延迟退出shell，稍后会再次尝试退出。

**checkwinsize**

> 如果开启了该选项，Bash在执行外部命令（非内建命令）之后会检查窗口大小。并且如果需要，会更新变量“LINES”和“COLUMNS”的值。该选项默认开启。

**cmdhist**

> 如果开启了该选项，Bash会试图将多行命令输入的所有行保存为一个命令历史记录。这使得多行命令更容易重新编辑。该选项默认开启，但仅在开启了命令历史记录才生效。

**compat31**
**compat32**
**compat40**
**compat41**
**compat42**
**compat43**
**compat44**

这些用于控制shell的兼容模式。（参见6.12《Shell兼容模式》）

**complete_fullquote**

> 如果开启了该项，Bash会在执行补全时将所有在文件名和目录名中的shell元字符引起来。如果关闭了该项，当像美元符号“$”这样的元字符出现在补全的多个单词中作为变量引用时，Bash会从将要引起来的已补全文件名的字符集中移除这样的元字符。也就是说，要扩展为目录的变量名中的美元符号“$”将不会被引起来；不管怎样，所有出现在文件名中的美元符号“$”也不会被引起来。这只有当Bash使用反斜线来引用补全的文件名时才被激活。该变量默认开启，其是Bash 4.2以后版本的默认行为。

**direxpand**

> 如果开启了该选项，当执行文件名补全时，Bash使用单词扩展的结果来替换目录名。这会改变读入行编辑缓冲的内容。如果未开启该项，Bash试图保留用户的输入。

**dirspell**

> 如果开启了该选项，如果最初提供的目录名不存在，Bash会试图在单词补全时对目录名进行拼写纠正。

**dotglob**

> 如果开启了该选项，Bash在文件名扩展结果中包含了以点符号“.”开头的文件名。文件名“.”和“..”必须始终被精确匹配，即使开启了“dotglob”选项。

**execfail**

> 如果开启了该选项，在一个非交互shell使用内建命令exec执行一个不能执行的外部命令时，其不会退出。交互式shell在使用exec执行命令失败后是不会退出的。

**expand_aliases**

> 如果开启了该选项，会依照6.6《别名》所描述的方式扩展别名。该项在交互模式下默认是开启的。

**extdebug**

> 如果在shell调用时，或在shell启动文件中开启此项，则在shell启动前安排执行debugger配置文件，其等同于Bash使用“--debugger”选项。如果在调用之后开启该项，则开启debugger的使用行为意图：

1. 在使用带有“-F”选项的内建命令“declare”显示函数名时，在其后显示该函数所在的源文件名和相应的所在行数。

2. 如果由DEBUG捕获器运行的命令返回一个非零值时，将跳过下一条命令不予执行。

3. 如果由DEBUG捕获器运行的命令返回值为2，并且shell正执行于一个子任务（由内建命令“.”或source执行的函数或脚本）中，则shell模拟调用return。

4. 变量BASH_ARGC和BASH_ARGV参照5.2《Bash变量》所描述的说明进行更新。

5. 开启函数追踪：命令替换、shell函数和使用“( command )”方式调用的子shell都继承DEBUG和RETURN捕获器。

6. 开启报错追踪：命令替换、shell函数和使用“( command )”方式调用的子shell都继承ERR捕获器。

**extglob**

> 如果开启了该选项，将开启在3.5.8.1《样式匹配》中描述的扩展样式匹配特性。

**extquote**

> 如果开启了该选项，在双引号括起来的“`${parameter}`”扩展中执行“`$'string'`”和“`$"string"`”引用。该选项默认开启。

**failglob**

> 如果开启了该选项，在文件名扩展期间匹配文件名失败的样式会在扩展报错中显示。

**force_fignore**

> 如果开启了该选项，当执行单词补全时，包含由shell变量FIGNORE所指定后缀的单词将被忽略，即使该单词是唯一的补全选项。详情参见5.2《Bash变量》中关于FIGNORE的描述。该项默认是开启的。

**globasciiranges**

> 如果开启了该选项，在进行匹配比较时，在样式匹配的中括号表达式中的范围表达式的行为就像在传统C语言区域中一样。也就是说，当前语言区域的校对序列不会在当前匹配中生效，所以不会在“A”和“B”之间校对到“b”，并且大写和小写ASCII字符会在一起校对。

**globstar**

> 如果开启了该选项，在文件名扩展上下文中的样式“**”将匹配到所有的文件和零个或多个目录及子目录。如果样式后面跟随着一个“/”，则只会匹配目录及子目录。

**gnu_errfmt**

> 如果开启了该选项，shell的报错信息会使用标准GNU报错格式书写。

**histappend**

> 如果开启了该选项，当shell退出时，命令历史列表将追加到变量HISTFILE所指定的文件中去，而不是覆盖这个文件。

**histreedit**

> 如果开启了该选项，并且使用了Readline，则用户可得到重新编辑一个失败命令历史替换的机会。

**histverify**

> 如果开启了该选项，并且使用了Readline，命令历史替换的结果不会立即传递给shell分析器。作为代替，结果行被加载到Readline编辑缓冲中，并允许进一步的修改。

**hostcomplete**

> 如果开启了该选项，并且使用了Readline，当一个单词中包含了一个“@”符号并进行补全操作时（参见8.4.6《用于补全的命令》），Bash会试图进行主机名补全操作。该项默认开启。

**huponexit**

> 如果开启了该选项，当一个交互式shell退出时，Bash将向所有作业发出SIGHUP信号。

**inherit_errexit**

> 如果开启了该选项，命令替换继承errexit选项的值，而不是在子shell环境中释放它。该项在POSIX模式下是开启的。

**interactive_comments**

在交互模式shell中允许在第一个单词之前出现“#”。这会使该单词及该行后面的字符都会被忽略。该项默认开启。

**lastpipe**

> 如果开启了该选项，并且作业控制没有激活的话，shell在当前环境中运行管道中最后一条命令不会在后台执行。

**lithist**

> 如果开启了该选项，并且也开启了cmdhist选项，保存到命令历史中的多行命令会使用换行进行分隔，而不是尽可能使用分号代替。

**localvar_inherit**

> 如果开启了该选项，在任意新值分配给本地变量之前，其会继承自上一作用域中相同名称的变量的值和属性。但不会继承“*nameref*”属性。

**localvar_unset**

> 如果开启了该选项，在上一函数作用域中调用“unset”释放本地变量时会先标记它们，这样直到该函数返回，再查打到这些变量进行释放。这等同于在当前函数作用域中释放本地变量的行为。

**login_shell**

> 如果shell作为登录shell（参见6.1《调用Bash》）启动，则shell设置此项为开启状态。该值是不可改变的。

**mailwarn**

> 如果开启了该选项，自上一次邮件检查后，当Bash为了检查邮件访问了一个文件，会显示“The mail in mailfile has been read”这条消息。

**no_empty_cmd_completion**

> 如果开启了该选项，并且使用了Readline，当试图在一空行中进行补全操作时，Bash不会为了可能的补全操作来试图搜索变量PATH。

**nocaseglob**

> 如果开启了该选项，在Bash执行文件名扩展时，会使用大小写不敏感方式对文件名进行匹配。

**nocasematch**

> 如果开启了该选项，Bash在使用case命令或“[[”条件命令执行匹配时，或执行样式替换的单词扩展时，或在作为可编程补全的一部分的可行补全过滤操作时，会使用大小写不敏感进行样式匹配。

**nullglob**

> 如果开启了该选项，Bash允许未匹配到任何文件的文件名样式扩展为一个空字符串，而不是扩展为其本身。

**progcomp**

> 如果开启了该选项，则开启可编程补全工具（详见8.6《可编程补全》）。该项默认开启。

**progcomp_alias**

> 如果开启了该选项，并且开启了可编程补全，Bash视一个没有任何补全可能的命令名为一个可行别名并试图进行别名扩展。如果其果真是别名，Bash试图使用从扩展的别名生成的命令单词进行可编程补全操作。

**promptvars**

> 如果开启了该选项，在参数扩展、命令替换、算术扩展和引用移除的扩展之后按6.9《提示控制》中所描述的出现提示字符串。该项默认开启。

**restricted_shell**

如果shell启动进入受限模式（参见6.10《Shell受限模式》），则设置此项开启。该项不能被修改。当执行启动文件时，该项不能被重置。但允许启动文件获取shell是否是在受限模式中。

**shift_verbose**

> 如果开启了该选项，当内建命令“shift”的移位数量超出了位置参数的个数时，会打印出错信息。

**sourcepath**

> 如果开启了该选项，内建命令“source”会使用变量PATH的值进行目录查找，用于查找作为“source”参数的文件位置。该项默认开启。

**xpg_echo**

> 如果开启了该选项，内建命令“echo”默认扩展反斜线转义序列。